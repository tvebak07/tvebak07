# Importer Active Directory modulet
Import-Module ActiveDirectory

# Funktion til at generere en tilfældig adgangskode
function Generate-RandomPassword {
    $length = 20
    $randomChars = 33..126 | Where-Object { $_ -ne 34 -and $_ -ne 39 } | ForEach-Object { [char]$_ }
    $password = ''
    1..$length | ForEach-Object { $password += $randomChars[(Get-Random -Minimum 0 -Maximum $randomChars.Length)] }
    return $password
}

# Hent dato og tid for start af script
$startTime = Get-Date

# Hent en liste over brugere fra OU (ændr stien til din OU)
$users = Get-ADUser -Filter * -SearchBase "OU=A0,OU=Priviliged Accounts - No Sync,OU=Automize-Access Rights-UA,DC=inside,DC=sjns,DC=dk"

# Gennemgå hver bruger og nulstil adgangskoden, ændre indstillinger og aktiver konto
foreach ($user in $users) {
    $newPassword = Generate-RandomPassword
    
    # Nulstil adgangskoden
    Set-ADAccountPassword -Identity $user -NewPassword (ConvertTo-SecureString -AsPlainText $newPassword -Force) -Reset

    # Fjern flueben for "Bruger skal skifte adgangskode ved næste logon"
    Set-ADUser -Identity $user -ChangePasswordAtLogon $false

    # Fjern flueben for "Adgangskoden udløber aldrig"
    Set-ADUser -Identity $user -PasswordNeverExpires $false

    # Fjern flueben for "Bruger kan ikke ændre adgangskoden"
    Set-ADUser -Identity $user -CannotChangePassword $false

    # Aktiver brugerkonto
    Enable-ADAccount -Identity $user

    # Hent first name og last name
    $firstName = $user.GivenName
    $lastName = $user.Surname

    # Udskriv brugernavn, first name, last name og den genererede adgangskode
    Write-Host "Brugernavn: $($user.UserPrincipalName)"
    Write-Host "First Name: $firstName"
    Write-Host "Last Name: $lastName"
    Write-Host "Adgangskode: $newPassword"
    Write-Host "Konto aktiveret: $($user.Enabled)"
    Write-Host "-----------------------------------"
}

# Hent dato og tid for slut af script
$endTime = Get-Date

# Udskriv starttidspunkt og sluttidspunkt for scriptet
Write-Host "Script startede kørsel: $($startTime.ToString('yyyy-MM-dd HH:mm:ss'))"
Write-Host "Script afsluttede kørsel: $($endTime.ToString('yyyy-MM-dd HH:mm:ss'))"
Write-Host "-----------------------------------"
